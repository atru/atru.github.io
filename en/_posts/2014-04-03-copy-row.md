---
layout: post
title:  "Copying a row of any table"
captitle:  "Copying a Row of Any Table"
date:   2014-04-03 17:10:56
categories: MSSQL
tags: sql
lang: en
---

Preamble
========

This is the continuation of a [post about storing all table columns][view_column] in one place.

What For?
========

Have you ever wanted to just tell MS SQL

>Copy the row of `[AdventureWorks2008].[SalesLT].[Product]` with `ProductID=986`!

and it would just copy the row? Not that you enumerated all the columns in an INSERT and SELECT clauses. But instead you wrote: copy, please. Wouldn't it be nice? If the table schema changed, you wouldn't need to enumerate another column.

Let me demonstrate.

<img width="100%" alt="Couldn't copy a row" src="/img/2014/copyrow_01.png" style="cursor:pointer" onclick="window.open('/img/2014/copyrow_01.png','_blank');return;"></img>

Sorry, but he said that unique index is stopping him from doing that. OK. Let's be gentle this time:

>Would you kindly copy the row of `[AdventureWorks2008].[SalesLT].[Product]` with `ProductID=986`, but set a new GUID for the `rowguid`, new `Name` and new `ProductNumber`?

<img width="100%" alt="Successfully copied a row" src="/img/2014/copyrow_02.png" style="cursor:pointer" onclick="window.open('/img/2014/copyrow_02.png','_blank');return;"></img>

That's it. MSSQL has just copied a row without specifying any INSERT or SELECT columns on our side. Needless to say how helpful that is sometimes.

How It Works
============

We store table schemas in a special table of our 'system' database. When the right time comes, we can get a table's list of columns enumerated in a string, e.g. `col1, col2, col3` and create a dynamic query where we would concatenate things like `INSERT INTO ` and ` OUR TABLE ` and ` (col1, col2, col3) ` and ` SELECT ` and ` col1, col2, col3 ` and ` FROM ` and ` OUR_TABLE ` and ` WHERE $IDENTITY=` and `OUR_PRODUCT_ID_VALUE`. Moreover, if we need to put some changes to the values, we simply replace some of the `colN` names with explicit values, like `SELECT col1, 'new value', col3 FROM OUR_TABLE`.

Once we have the query, we run it, and the magic happens.

If we ever add new columns to our table, we ask a special procedure to 'refresh' all schemas, and the column gets enumerated along with others, so we don't need to keep track of any copying routines in our system.

Here Comes the Inside
=====================

If you're interested in the mechanism behind such functionality &mdash; be my guest.

[view_column]: {{ site.url }}/en/2014/02/18/view-column.html
